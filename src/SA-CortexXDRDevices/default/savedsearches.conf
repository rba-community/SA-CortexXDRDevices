# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[Cortex XDR Devices - Lookup Gen]
disabled = false
cron_schedule = 23 * * * *
description = Generate an ES Assets list from XDR data.
dispatch.earliest_time = -65m@m
dispatch.latest_time = -5m@m
enableSched = 1
schedule_window = auto
search = `sa_cortex_xdr_index` sourcetype=cortex:xdr:endpoints\
| dedup endpoint_id \
| rename ip{} as ip, mac_address{} as mac, users{} as owner, group_name{} as bunit\
    ``` Filter out non-useful groups ``` \
| eval bunit=mvfilter(NOT match(bunit, "ALL|All")) \
| eval ip=mvjoin(ip, "|"), mac=mvjoin(mac, "|"), owner=mvjoin(owner, "|"), bunit=mvjoin(bunit, "|") \
| eval nt_host=lower(endpoint_name) \
| eval dns=nt_host + "." + domain\
    ``` last_seen is in milliseconds ``` \
| eval last_seen=round(last_seen/1000, 0) \
| eval _key=sha1(nt_host), _last_seen=last_seen \
| convert ctime(last_seen) \
| eval priority=if(endpoint_type="AGENT_TYPE_SERVER", "high", "medium") \
| eval category=mvjoin(mvsort(mvappend("xdr_os: ".operating_system,\
    "gen: sa-cortexxdrdevices",\
    "xdr_policy: ".assigned_prevention_policy,\
    "xdr_content_status: ".content_status,\
    "xdr_last_seen: ".last_seen,\
    "xdr_package: ".installation_package,\
    "xdr_operational_status: ".operational_status)), "|") \
| iplocation public_ip\
| rename Country as country, City as city, lon as long\
| table _key,_last_seen,ip,mac,nt_host,dns,bunit,priority,category,city,country,lat,long\
| outputlookup append=t key_field=_key xdr_devices \
| stats count
